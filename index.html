<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>테트리스 블록 대포 게임</title>
    <style>
        body {
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background-color: #2c3e50;
            font-family: Arial, sans-serif;
        }
        #game-container {
            text-align: center;
        }
        #instructions {
            color: white;
            margin-bottom: 10px;
            font-size: 16px;
        }
        #game {
            border: 2px solid #fff;
            background-color: #87CEEB;
        }
        #debug {
            color: white;
            margin-top: 10px;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div id="game-container">
        <div id="instructions">클릭하여 테트리스 블록 발사!</div>
        <div id="game"></div>
        <div id="debug">디버그 정보가 여기에 표시됩니다</div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/phaser/3.70.0/phaser.min.js"></script>
    <script>
        const debugElement = document.getElementById('debug');
        
        function log(message) {
            console.log(message);
            debugElement.textContent = message;
        }

        class GameScene extends Phaser.Scene {
            constructor() {
                super({ key: 'GameScene' });
                this.cannon = null;
                this.blocks = [];
                this.canShoot = true;
                this.blockCount = 0;
                this.gameOver = false;
            }

            create() {
                log("게임 scene 생성 중...");
                
                // 배경색 설정
                this.cameras.main.setBackgroundColor('#87CEEB');
                
                // 바닥 생성 (구멍이 있는 바닥)
                const groundGraphics = this.add.graphics();
                groundGraphics.fillStyle(0x8B4513);
                
                // 왼쪽 바닥
                groundGraphics.fillRect(0, 560, 150, 40);
                // 가운데 바닥 
                groundGraphics.fillRect(250, 560, 300, 40);
                // 오른쪽 바닥
                groundGraphics.fillRect(650, 560, 150, 40);
                
                // 물리 바닥들 (구멍 제외)
                this.matter.add.rectangle(75, 580, 150, 40, { 
                    isStatic: true,
                    label: 'ground'
                });
                this.matter.add.rectangle(400, 580, 300, 40, { 
                    isStatic: true,
                    label: 'ground'
                });
                this.matter.add.rectangle(725, 580, 150, 40, { 
                    isStatic: true,
                    label: 'ground'
                });

                // 좌우 벽 (시각적)
                const wallGraphics = this.add.graphics();
                wallGraphics.fillStyle(0x8B4513);
                wallGraphics.fillRect(0, 0, 40, 600); // 왼쪽 벽
                wallGraphics.fillRect(760, 0, 40, 600); // 오른쪽 벽
                
                // 물리 벽
                this.matter.add.rectangle(20, 300, 40, 600, { 
                    isStatic: true,
                    label: 'leftWall'
                });
                this.matter.add.rectangle(780, 300, 40, 600, { 
                    isStatic: true,
                    label: 'rightWall'
                });

                // 대포 생성
                this.createCannon();

                // 클릭 이벤트 (포인터 위치 정보 포함)
                this.input.on('pointerdown', (pointer) => {
                    this.shootBlock(pointer);
                }, this);
                
                log("게임 초기화 완료! 클릭해보세요.");
            }

            createCannon() {
                // 뿌요뿌요 스타일 위쪽 대포 그래픽 생성
                this.cannon = this.add.graphics();
                
                // 대포 받침대 (넓은 베이스) - 맨 위쪽
                this.cannon.fillStyle(0x444444);
                this.cannon.fillRoundedRect(360, 20, 80, 40, 8);
                
                // 대포 본체 (짧고 통통한 원통)
                this.cannon.fillStyle(0x333333);
                this.cannon.fillRoundedRect(375, 50, 50, 50, 10);
                
                // 대포 포신 (아래쪽을 향한 짧은 총구)
                this.cannon.fillStyle(0x222222);
                this.cannon.fillRoundedRect(390, 95, 20, 25, 5);
                
                // 대포 장식 고리들
                this.cannon.lineStyle(3, 0x666666);
                this.cannon.strokeRect(375, 55, 50, 8);
                this.cannon.strokeRect(375, 70, 50, 8);
                this.cannon.strokeRect(375, 85, 50, 8);
                
                // 발사구 하이라이트
                this.cannon.fillStyle(0x555555);
                this.cannon.fillCircle(400, 107, 6);
            }

            shootBlock() {
                if (!this.canShoot || this.gameOver) {
                    if (this.gameOver) {
                        log("게임 오버! 새로고침하여 다시 시작하세요.");
                    } else {
                        log("쿨타임 중... 잠시 기다려주세요");
                    }
                    return;
                }
                
                this.blockCount++;
                log(`블록 ${this.blockCount}번 발사!`);

                // 블록 색상들
                const colors = [
                    0xff0000, // 빨강
                    0x00ff00, // 초록
                    0x0000ff, // 파랑
                    0xffff00, // 노랑
                    0xff00ff, // 마젠타
                    0x00ffff, // 시안
                    0xff8000, // 주황
                    0x8000ff  // 보라
                ];
                
                const randomColor = colors[Math.floor(Math.random() * colors.length)];
                
                // 블록 생성 위치 (대포 포신 끝)
                const startX = 400;
                const startY = 125; // 대포 포신 끝 위치
                
                // 시각적 블록 생성 (Phaser 스프라이트)
                const visualBlock = this.add.rectangle(startX, startY, 30, 30, randomColor);
                visualBlock.setStrokeStyle(2, 0x000000); // 검은색 테두리
                
                // 물리 블록 생성 (투명하게)
                const physicsBlock = this.matter.add.rectangle(startX, startY, 30, 30, {
                    restitution: 0.4,
                    friction: 0.7,
                    frictionAir: 0.01,
                    label: 'block',
                    render: { visible: false } // 물리 블록은 안 보이게
                });
                
                // 시각적 블록과 물리 블록 연결
                const blockPair = { visual: visualBlock, physics: physicsBlock };
                
                // 발사 속도 (아래쪽으로)
                const velocityX = (Math.random() - 0.5) * 4; // 좌우 랜덤
                const velocityY = 2; // 아래쪽으로 천천히
                
                this.matter.body.setVelocity(physicsBlock, { x: velocityX, y: velocityY });
                
                // 블록 회전
                this.matter.body.setAngularVelocity(physicsBlock, (Math.random() - 0.5) * 0.2);

                this.blocks.push(blockPair);

                // 대포 발사 효과
                this.tweens.add({
                    targets: this.cannon,
                    scaleY: 0.95,
                    scaleX: 1.05,
                    duration: 100,
                    yoyo: true,
                    ease: 'Power2'
                });

                // 발사 사운드 효과 (시각적) - 대포 포신에서
                const flash = this.add.circle(400, 107, 20, 0xffff00, 0.8);
                this.tweens.add({
                    targets: flash,
                    alpha: 0,
                    scale: 2,
                    duration: 200,
                    onComplete: () => flash.destroy()
                });

                // 쿨타임 설정
                this.canShoot = false;
                this.time.delayedCall(400, () => {
                    this.canShoot = true;
                    log(`다음 블록 준비 완료! (총 ${this.blockCount}개 발사됨)`);
                });
            }

            update() {
                // 시각적 블록과 물리 블록 위치 동기화
                this.blocks.forEach(blockPair => {
                    if (blockPair.physics && blockPair.visual) {
                        // 테트리스 블록 그룹의 위치 업데이트
                        const centerX = blockPair.physics.position.x;
                        const centerY = blockPair.physics.position.y;
                        const angle = blockPair.physics.angle;
                        
                        blockPair.visual.setPosition(centerX, centerY);
                        blockPair.visual.setRotation(angle);
                        
                        // 게임오버 구역 체크 (왼쪽 구멍: x 150-250, 오른쪽 구멍: x 550-650)
                        const pos = blockPair.physics.position;
                        if (pos.y > 570) { // 바닥 근처에 도달했을 때
                            if ((pos.x > 150 && pos.x < 250) || (pos.x > 550 && pos.x < 650)) {
                                this.triggerGameOver();
                                return;
                            }
                        }
                    }
                });
                
                // 화면 밖으로 나간 블록들 정리
                this.blocks = this.blocks.filter(blockPair => {
                    const pos = blockPair.physics.position;
                    if (pos.y > 650 || pos.x < -50 || pos.x > 850) {
                        // 물리 블록 제거
                        this.matter.world.remove(blockPair.physics);
                        // 시각적 블록 제거
                        blockPair.visual.destroy();
                        return false;
                    }
                    return true;
                });
            }
            
            triggerGameOver() {
                this.gameOver = true;
                log("게임 오버! 블록이 구멍에 떨어졌습니다!");
                
                // 게임오버 효과
                this.cameras.main.shake(300, 0.02);
                
                // 게임오버 텍스트 표시
                this.add.text(400, 300, 'GAME OVER!', {
                    fontSize: '48px',
                    fill: '#ff0000',
                    fontWeight: 'bold',
                    stroke: '#ffffff',
                    strokeThickness: 4
                }).setOrigin(0.5);
                
                this.add.text(400, 350, '새로고침하여 다시 시작', {
                    fontSize: '24px',
                    fill: '#ffffff',
                    fontWeight: 'bold',
                    stroke: '#000000',
                    strokeThickness: 2
                }).setOrigin(0.5);
            }
        }

        // 게임 설정
        const config = {
            type: Phaser.AUTO,
            width: 800,
            height: 600,
            parent: 'game',
            backgroundColor: '#87CEEB',
            physics: {
                default: 'matter',
                matter: {
                    gravity: { y: 0.8 },
                    debug: false, // true로 바꾸면 물리 바디가 보임
                    enableSleeping: false
                }
            },
            scene: GameScene
        };

        // 게임 시작
        try {
            const game = new Phaser.Game(config);
            log("게임 로딩 완료!");
        } catch (error) {
            log("게임 시작 에러: " + error.message);
            console.error(error);
        }
    </script>
</body>
</html>